{% extends 'base.html.twig' %}

{% block title %}Admin - {{ bien ? 'Modifier' : 'Nouveau' }} Bien{% endblock %}

{% block stylesheets %}
<style>
    .compact-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .compact-grid .section { margin-bottom: 0; }
    .compact-grid .section h4 { font-size: 0.9rem; margin-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.35rem; }
    .compact-grid .form-group { margin-bottom: 0.5rem; }
    .compact-grid .form-group label { font-size: 0.8rem; margin-bottom: 0.15rem; }
    .compact-grid .form-group input,
    .compact-grid .form-group select,
    .compact-grid .form-group textarea { padding: 0.35rem 0.5rem; font-size: 0.85rem; }
    .compact-grid .form-inline { gap: 0.35rem; flex-wrap: wrap; }
    .compact-grid .section-item { padding: 0.35rem 0; font-size: 0.85rem; }
    .field-row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: end; margin-bottom: 0.35rem; }
    .field-row .form-group { margin-bottom: 0; flex: 0 0 auto; }
    .full-width { grid-column: 1 / -1; }
    .autocomplete-wrapper { position: relative; }
    .autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 50; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .autocomplete-results.active { display: block; }
    .autocomplete-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.85rem; }
    .autocomplete-item:hover { background: #f1f5f9; }
    .autocomplete-item .sub { font-size: 0.75rem; color: #94a3b8; }
    @media (max-width: 768px) {
        .compact-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block body %}
<div class="page-header">
    <h1>{{ bien ? 'Modifier le Bien #' ~ bien.id : 'Nouveau Bien' }}</h1>
    <div>
        {% if bien %}
            <a href="{{ path('biens_detail', {id: bien.id}) }}" class="btn btn-primary">Voir le bien</a>
        {% endif %}
        <a href="{{ path('admin_biens') }}" class="btn btn-secondary">Retour</a>
    </div>
</div>

{# ===== Property form ===== #}
<div class="card">
    <h3>Informations du bien</h3>
    <form method="POST">
        <input type="hidden" name="_action" value="{{ bien ? 'update_bien' : 'create_bien' }}">
        <div class="form-row">
            <div class="form-group">
                <label>Rue *</label>
                <input type="text" name="rue" value="{{ bien ? bien.rue : '' }}" required>
            </div>
            <div class="form-group">
                <label>Ville *</label>
                <input type="text" name="ville" value="{{ bien ? bien.ville : '' }}" required>
            </div>
            <div class="form-group">
                <label>Code Postal *</label>
                <input type="text" name="codePostal" value="{{ bien ? bien.codePostal : '' }}" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Type</label>
                <select name="type">
                    <option value="">-</option>
                    {% for t in ['APPARTEMENT', 'MAISON', 'STUDIO', 'TERRAIN'] %}
                        <option value="{{ t }}" {{ (bien and bien.type == t) ? 'selected' }}>{{ t }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Superficie (m2)</label>
                <input type="number" name="superficie" value="{{ bien ? bien.superficie : '' }}">
            </div>
            <div class="form-group">
                <label>Eco Score</label>
                <input type="number" name="ecoScore" min="0" max="10" value="{{ bien ? bien.ecoScore : '' }}">
            </div>
        </div>
        {% if not bien and app.session.get('user').role == 'SUPER_ADMIN' %}
        <div class="form-group">
            <label>Agence</label>
            <select name="agenceId">
                <option value="">Aucune</option>
                {% for a in agences %}
                    <option value="{{ a.id }}">{{ a.nom }} ({{ a.ville }})</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <div class="form-group">
            <label>Description</label>
            <textarea name="description" style="min-height: 50px;">{{ bien ? bien.description : '' }}</textarea>
        </div>
        {% if not bien %}
        <div class="form-group">
            <label>Proprietaire *</label>
            <input type="hidden" name="personneId" id="createProprietaireId" value="" required>
            <div class="autocomplete-wrapper">
                <input type="text" id="createProprietaireSearch" autocomplete="off"
                       placeholder="Rechercher par nom ou prenom..." required>
                <div class="autocomplete-results" id="createProprietaireResults"></div>
            </div>
        </div>
        {% endif %}
        <button type="submit" class="btn btn-primary">{{ bien ? 'Enregistrer' : 'Creer' }}</button>
    </form>
</div>

{# ===== The rest only shows when editing an existing property ===== #}
{% if bien %}

<div class="compact-grid">

{# ===== Sale listing ===== #}
<div class="section">
    <h4>Annonce de vente</h4>
    {% if bien.achat %}
        <form method="POST">
            <input type="hidden" name="_action" value="update_achat">
            <input type="hidden" name="achatId" value="{{ bien.achat.id }}">
            <div class="field-row">
                <div class="form-group">
                    <label>Prix</label>
                    <input type="number" name="prix" step="0.01" value="{{ bien.achat.prix }}" required style="width: 120px;">
                </div>
                <div class="form-group">
                    <label>Dispo</label>
                    <input type="date" name="dateDispo" value="{{ bien.achat.dateDispo }}" required>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">OK</button>
            </div>
        </form>
        <form method="POST">
            <input type="hidden" name="_action" value="remove_achat">
            <input type="hidden" name="achatId" value="{{ bien.achat.id }}">
            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Supprimer ?')">Supprimer</button>
        </form>
    {% else %}
        <form method="POST">
            <input type="hidden" name="_action" value="add_achat">
            <div class="field-row">
                <div class="form-group">
                    <label>Prix</label>
                    <input type="number" name="prix" step="0.01" required style="width: 120px;">
                </div>
                <div class="form-group">
                    <label>Dispo</label>
                    <input type="date" name="dateDispo" value="{{ 'now'|date('Y-m-d') }}" required>
                </div>
                <button type="submit" class="btn btn-success btn-sm">Ajouter</button>
            </div>
        </form>
    {% endif %}
</div>

{# ===== Rental listing ===== #}
<div class="section">
    <h4>Annonce de location</h4>
    {% if bien.location %}
        <form method="POST">
            <input type="hidden" name="_action" value="update_location">
            <input type="hidden" name="locationId" value="{{ bien.location.id }}">
            <div class="field-row">
                <div class="form-group">
                    <label>Loyer</label>
                    <input type="number" name="mensualite" step="0.01" value="{{ bien.location.mensualite }}" required style="width: 90px;">
                </div>
                <div class="form-group">
                    <label>Caution</label>
                    <input type="number" name="caution" step="0.01" value="{{ bien.location.caution }}" required style="width: 90px;">
                </div>
                <div class="form-group">
                    <label>Dispo</label>
                    <input type="date" name="dateDispo" value="{{ bien.location.dateDispo }}" required>
                </div>
                <div class="form-group">
                    <label>Duree (mois)</label>
                    <input type="number" name="dureeMois" value="{{ bien.location.dureeMois }}" style="width: 55px;">
                </div>
                <button type="submit" class="btn btn-primary btn-sm">OK</button>
            </div>
        </form>
        <form method="POST">
            <input type="hidden" name="_action" value="remove_location">
            <input type="hidden" name="locationId" value="{{ bien.location.id }}">
            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Supprimer ?')">Supprimer</button>
        </form>
    {% else %}
        <form method="POST">
            <input type="hidden" name="_action" value="add_location">
            <div class="field-row">
                <div class="form-group">
                    <label>Loyer</label>
                    <input type="number" name="mensualite" step="0.01" required style="width: 90px;">
                </div>
                <div class="form-group">
                    <label>Caution</label>
                    <input type="number" name="caution" step="0.01" required style="width: 90px;">
                </div>
                <div class="form-group">
                    <label>Dispo</label>
                    <input type="date" name="dateDispo" value="{{ 'now'|date('Y-m-d') }}" required>
                </div>
                <div class="form-group">
                    <label>Duree (mois)</label>
                    <input type="number" name="dureeMois" style="width: 55px;">
                </div>
                <button type="submit" class="btn btn-success btn-sm">Ajouter</button>
            </div>
        </form>
    {% endif %}
</div>

{# ===== Owner (single) — hidden for CLIENTs ===== #}
{% if app.session.get('user_role') != 'CLIENT' %}
<div class="section">
    <h4>Proprietaire</h4>
    {% set currentOwner = (bien.proprietaires is defined and bien.proprietaires|length > 0) ? bien.proprietaires[0] : null %}
    {% if currentOwner %}
        <div class="section-item">
            <span><strong>{{ currentOwner.prenom }} {{ currentOwner.nom }}</strong> ({{ currentOwner.dateDebut|slice(0, 10) }})</span>
            <form method="POST" style="display:inline;">
                <input type="hidden" name="_action" value="remove_proprietaire">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Retirer ?')">X</button>
            </form>
        </div>
    {% endif %}
    <form method="POST">
        <input type="hidden" name="_action" value="set_proprietaire">
        <input type="hidden" name="personneId" id="proprietaireId" value="{{ currentOwner ? currentOwner.personneId : '' }}" required>
        <div class="field-row">
            <div class="form-group autocomplete-wrapper" style="flex: 1; min-width: 120px;">
                <input type="text" id="proprietaireSearch" autocomplete="off"
                       placeholder="Rechercher par nom ou prenom..."
                       value="{{ currentOwner ? currentOwner.prenom ~ ' ' ~ currentOwner.nom : '' }}">
                <div class="autocomplete-results" id="proprietaireResults"></div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">{{ currentOwner ? 'Modifier' : 'Definir' }}</button>
        </div>
    </form>
</div>
{% endif %}

{# ===== Photos ===== #}
<div class="section">
    <h4>Photos</h4>
    {% if bien.photos is defined and bien.photos|length > 0 %}
        {% for photo in bien.photos %}
            <div class="section-item">
                <span>{{ photo.chemin|length > 40 ? photo.chemin|slice(0, 40) ~ '...' : photo.chemin }} (#{{ photo.ordre }})</span>
                <form method="POST" style="display:inline;">
                    <input type="hidden" name="_action" value="remove_photo">
                    <input type="hidden" name="photoId" value="{{ photo.id }}">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Supprimer ?')">X</button>
                </form>
            </div>
        {% endfor %}
    {% else %}
        <p style="color: #94a3b8; font-size: 0.8rem;">Aucune photo.</p>
    {% endif %}
    <form method="POST" enctype="multipart/form-data" style="margin-top: 0.25rem;">
        <input type="hidden" name="_action" value="add_photo">
        <div class="field-row">
            <div class="form-group" style="flex: 1; min-width: 100px;">
                <input type="file" name="photo_file" accept="image/*" id="photo_file_input" style="font-size: 0.8rem;">
            </div>
            <div class="form-group" style="flex: 1; min-width: 100px;">
                <input type="text" name="chemin" placeholder="ou URL de la photo" id="photo_url_input">
            </div>
            <div class="form-group">
                <input type="number" name="ordre" min="1" value="1" style="width: 50px;">
            </div>
            <button type="submit" class="btn btn-success btn-sm">+</button>
        </div>
    </form>
    <script>
        document.getElementById('photo_file_input').addEventListener('change', function() {
            if (this.files.length > 0) document.getElementById('photo_url_input').value = '';
        });
        document.getElementById('photo_url_input').addEventListener('input', function() {
            if (this.value) document.getElementById('photo_file_input').value = '';
        });
    </script>
</div>

{# ===== Characteristics ===== #}
{% if caracteristiques is defined %}
<div class="section">
    <h4>Caracteristiques</h4>
    {% if bien.caracteristiques is defined and bien.caracteristiques|length > 0 %}
        {% for c in bien.caracteristiques %}
            <div class="section-item">
                <span>{{ c.lib }}: {{ c.valeur }}{% if c.unite %} {{ c.unite }}{% endif %}</span>
                <form method="POST" style="display:inline;">
                    <input type="hidden" name="_action" value="remove_caracteristique">
                    <input type="hidden" name="caracteristiqueId" value="{{ c.caracteristiqueId }}">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Retirer ?')">X</button>
                </form>
            </div>
        {% endfor %}
    {% else %}
        <p style="color: #94a3b8; font-size: 0.8rem;">Aucune.</p>
    {% endif %}
    <form method="POST" style="margin-top: 0.25rem;">
        <input type="hidden" name="_action" value="add_caracteristique">
        <div class="field-row">
            <div class="form-group" style="flex: 1; min-width: 100px;">
                <select name="caracteristiqueId" required>
                    <option value="">-- Choisir --</option>
                    {% for c in caracteristiques %}
                        <option value="{{ c.id }}">{{ c.lib }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <input type="text" name="valeur" required placeholder="Valeur" style="width: 70px;">
            </div>
            <div class="form-group">
                <input type="text" name="unite" placeholder="Unite" style="width: 60px;">
            </div>
            <button type="submit" class="btn btn-success btn-sm">+</button>
        </div>
    </form>
</div>
{% endif %}

{# ===== Nearby places ===== #}
{% if lieux is defined %}
<div class="section">
    <h4>Proximite</h4>
    {% if bien.lieux is defined and bien.lieux|length > 0 %}
        {% for l in bien.lieux %}
            <div class="section-item">
                <span>{{ l.lib }} — {{ l.minutes }}min {% if l.typeLocomotion %}({{ l.typeLocomotion }}){% endif %}</span>
                <form method="POST" style="display:inline;">
                    <input type="hidden" name="_action" value="remove_lieu">
                    <input type="hidden" name="lieuId" value="{{ l.lieuId }}">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Retirer ?')">X</button>
                </form>
            </div>
        {% endfor %}
    {% else %}
        <p style="color: #94a3b8; font-size: 0.8rem;">Aucun.</p>
    {% endif %}
    <form method="POST" style="margin-top: 0.25rem;">
        <input type="hidden" name="_action" value="add_lieu">
        <div class="field-row">
            <div class="form-group" style="flex: 1; min-width: 100px;">
                <select name="lieuId" required>
                    <option value="">-- Choisir --</option>
                    {% for l in lieux %}
                        <option value="{{ l.id }}">{{ l.lib }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <input type="number" name="minutes" min="1" required placeholder="Min" style="width: 60px;">
            </div>
            <div class="form-group">
                <select name="typeLocomotion">
                    <option value="">-</option>
                    <option value="MARCHE">Pied</option>
                    <option value="VELO">Velo</option>
                    <option value="TRANSPORT_PUBLIC">Bus/Metro</option>
                    <option value="VOITURE">Voiture</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success btn-sm">+</button>
        </div>
    </form>
</div>
{% endif %}

</div>{# end compact-grid #}

{% endif %}{# end if bien #}

<script>
(function() {
    var searchUrl = '{{ path("admin_personnes_search_json") }}';
    var timer = null;

    function setupAutocomplete(inputId, hiddenId, resultsId) {
        var input = document.getElementById(inputId);
        var hidden = document.getElementById(hiddenId);
        var results = document.getElementById(resultsId);
        if (!input) return;

        input.addEventListener('input', function() {
            hidden.value = '';
            var q = this.value.trim();
            clearTimeout(timer);
            if (q.length < 1) { results.classList.remove('active'); return; }
            timer = setTimeout(function() {
                fetch(searchUrl + '?q=' + encodeURIComponent(q))
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        results.innerHTML = '';
                        if (data.length === 0) {
                            results.innerHTML = '<div class="autocomplete-item" style="color:#94a3b8;">Aucun resultat</div>';
                        } else {
                            data.forEach(function(p) {
                                var div = document.createElement('div');
                                div.className = 'autocomplete-item';
                                div.innerHTML = '<strong>' + p.prenom + ' ' + p.nom + '</strong>' +
                                    (p.ville ? '<div class="sub">' + p.ville + '</div>' : '');
                                div.addEventListener('click', function() {
                                    input.value = p.prenom + ' ' + p.nom;
                                    hidden.value = p.id;
                                    results.classList.remove('active');
                                });
                                results.appendChild(div);
                            });
                        }
                        results.classList.add('active');
                    });
            }, 250);
        });

        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !results.contains(e.target)) {
                results.classList.remove('active');
            }
        });
    }

    setupAutocomplete('proprietaireSearch', 'proprietaireId', 'proprietaireResults');
    setupAutocomplete('createProprietaireSearch', 'createProprietaireId', 'createProprietaireResults');

    // Validate owner selection on creation form
    var createHidden = document.getElementById('createProprietaireId');
    if (createHidden) {
        createHidden.closest('form').addEventListener('submit', function(e) {
            if (!createHidden.value) {
                e.preventDefault();
                alert('Veuillez selectionner un proprietaire.');
            }
        });
    }
})();
</script>
{% endblock %}
