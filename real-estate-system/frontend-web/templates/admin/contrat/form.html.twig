{% extends 'base.html.twig' %}

{% block title %}Admin - Nouveau Contrat{% endblock %}

{% block body %}
<div class="page-header">
    <h1>Nouveau Contrat</h1>
    <a href="{{ path('admin_contrats') }}" class="btn btn-secondary">Retour</a>
</div>

<div class="card">
    <form method="POST">
        <div class="form-group">
            <label>Type de contrat *</label>
            <select name="contractType" id="contractType" onchange="toggleType()" required>
                <option value="">-- Choisir --</option>
                <option value="ACHAT">Achat (Vente)</option>
                <option value="LOCATION">Location</option>
            </select>
        </div>

        <div class="form-group" id="achatSelect" style="display:none;">
            <label>Annonce de vente *</label>
            <select name="achatId">
                <option value="">-- Choisir --</option>
                {% for b in biensForSale %}
                    <option value="{{ b.id }}">{{ b.type }} - {{ b.rue }}, {{ b.ville }} ({{ b.salePrice|number_format(0, ',', ' ') }} €)</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" id="locationSelect" style="display:none;">
            <label>Annonce de location *</label>
            <select name="locationId">
                <option value="">-- Choisir --</option>
                {% for b in biensForRent %}
                    <option value="{{ b.id }}">{{ b.type }} - {{ b.rue }}, {{ b.ville }} ({{ b.monthlyRent|number_format(0, ',', ' ') }} €/mois)</option>
                {% endfor %}
            </select>
        </div>

        <h3 style="margin: 1.5rem 0 0.75rem;">Cosignataires (minimum 2)</h3>

        <div id="cosigners">
            {% for i in 0..1 %}
            <div class="form-row" style="margin-bottom: 0.5rem;">
                <div class="form-group">
                    <label>Personne {{ i + 1 }} *</label>
                    <select name="cosigner_personne[]" required>
                        <option value="">-- Choisir --</option>
                        {% for p in personnes %}
                            <option value="{{ p.id }}">{{ p.prenom }} {{ p.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select name="cosigner_type[]" required>
                        <option value="BUYER">Acheteur</option>
                        <option value="SELLER">Vendeur</option>
                        <option value="RENTER">Locataire</option>
                        <option value="OWNER">Proprietaire</option>
                    </select>
                </div>
            </div>
            {% endfor %}
        </div>

        <button type="button" class="btn btn-secondary btn-sm" onclick="addCosigner()" style="margin-bottom: 1rem;">+ Ajouter un cosignataire</button>

        <div>
            <button type="submit" class="btn btn-primary">Creer le contrat</button>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
<script>
function toggleType() {
    var type = document.getElementById('contractType').value;
    document.getElementById('achatSelect').style.display = type === 'ACHAT' ? 'block' : 'none';
    document.getElementById('locationSelect').style.display = type === 'LOCATION' ? 'block' : 'none';
}

function addCosigner() {
    var container = document.getElementById('cosigners');
    var count = container.querySelectorAll('.form-row').length + 1;
    var html = '<div class="form-row" style="margin-bottom: 0.5rem;">' +
        '<div class="form-group"><label>Personne ' + count + '</label>' +
        '<select name="cosigner_personne[]"><option value="">-- Choisir --</option>' +
        '{% for p in personnes %}<option value="{{ p.id }}">{{ p.prenom }} {{ p.nom }}</option>{% endfor %}' +
        '</select></div>' +
        '<div class="form-group"><label>Role</label>' +
        '<select name="cosigner_type[]">' +
        '<option value="BUYER">Acheteur</option><option value="SELLER">Vendeur</option>' +
        '<option value="RENTER">Locataire</option><option value="OWNER">Proprietaire</option>' +
        '</select></div></div>';
    container.insertAdjacentHTML('beforeend', html);
}
</script>
{% endblock %}
