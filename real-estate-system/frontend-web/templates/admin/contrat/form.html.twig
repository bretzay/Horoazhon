{% extends 'base.html.twig' %}

{% block title %}Admin - Nouveau Contrat{% endblock %}

{% block stylesheets %}
<style>
    .autocomplete-wrapper { position: relative; }
    .autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; z-index: 50; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .autocomplete-results.active { display: block; }
    .autocomplete-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.85rem; }
    .autocomplete-item:hover { background: #f1f5f9; }
    .autocomplete-item .sub { font-size: 0.75rem; color: #94a3b8; }
</style>
{% endblock %}

{% block body %}
<div class="page-header">
    <h1>Nouveau Contrat</h1>
    <a href="{{ path('admin_contrats') }}" class="btn btn-secondary">Retour</a>
</div>

<div class="card">
    <form method="POST">
        <div class="form-group">
            <label>Type de contrat *</label>
            <select name="contractType" id="contractType" onchange="toggleType()" required>
                <option value="">-- Choisir --</option>
                <option value="ACHAT">Achat (Vente)</option>
                <option value="LOCATION">Location</option>
            </select>
        </div>

        <div class="form-group" id="achatSelect" style="display:none;">
            <label>Annonce de vente *</label>
            <select name="achatId" id="achatId" onchange="updateOwner()">
                <option value="">-- Choisir --</option>
                {% for a in achats %}
                    <option value="{{ a.id }}" data-bien-id="{{ a.bienId }}">{{ a.bienType }} - {{ a.bienRue }}, {{ a.bienVille }} ({{ a.prix|number_format(0, ',', ' ') }} &euro;)</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" id="locationSelect" style="display:none;">
            <label>Annonce de location *</label>
            <select name="locationId" id="locationId" onchange="updateOwner()">
                <option value="">-- Choisir --</option>
                {% for l in locations %}
                    <option value="{{ l.id }}" data-bien-id="{{ l.bienId }}">{{ l.bienType }} - {{ l.bienRue }}, {{ l.bienVille }} ({{ l.mensualite|number_format(0, ',', ' ') }} &euro;/mois)</option>
                {% endfor %}
            </select>
        </div>

        <div id="partiesSection" style="display:none;">
            <h3 style="margin: 1.5rem 0 0.75rem;">Parties au contrat</h3>

            <div class="form-group">
                <label id="sellerLabel">Vendeur</label>
                <input type="text" id="ownerDisplay" readonly style="background: #f1f5f9; cursor: not-allowed;" value="">
            </div>

            <div class="form-group autocomplete-wrapper">
                <label id="buyerLabel"></label>
                <input type="hidden" name="buyer_personne" id="buyerHidden" required>
                <input type="text" id="buyerSearch" autocomplete="off" placeholder="Rechercher par nom ou prenom...">
                <div class="autocomplete-results" id="buyerResults"></div>
            </div>

            <div style="margin-top: 1rem;">
                <button type="submit" class="btn btn-primary">Creer le contrat</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
<script>
var bienOwners = {{ bienOwners|json_encode|raw }};
var searchUrl = '{{ path("admin_personnes_search_json") }}';
var currentType = '';
var currentOwnerId = null;

function setupAutocomplete(inputEl, hiddenEl, resultsEl) {
    var timer = null;
    inputEl.addEventListener('input', function() {
        hiddenEl.value = '';
        var q = this.value.trim();
        clearTimeout(timer);
        if (q.length < 1) { resultsEl.classList.remove('active'); return; }
        timer = setTimeout(function() {
            fetch(searchUrl + '?q=' + encodeURIComponent(q))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    resultsEl.innerHTML = '';
                    var filtered = data.filter(function(p) { return p.id !== currentOwnerId; });
                    if (filtered.length === 0) {
                        resultsEl.innerHTML = '<div class="autocomplete-item" style="color:#94a3b8;">Aucun resultat</div>';
                    } else {
                        filtered.forEach(function(p) {
                            var div = document.createElement('div');
                            div.className = 'autocomplete-item';
                            div.innerHTML = '<strong>' + p.prenom + ' ' + p.nom + '</strong>' +
                                (p.ville ? '<div class="sub">' + p.ville + '</div>' : '');
                            div.addEventListener('click', function() {
                                inputEl.value = p.prenom + ' ' + p.nom;
                                hiddenEl.value = p.id;
                                resultsEl.classList.remove('active');
                            });
                            resultsEl.appendChild(div);
                        });
                    }
                    resultsEl.classList.add('active');
                });
        }, 250);
    });

    document.addEventListener('click', function(e) {
        if (!inputEl.contains(e.target) && !resultsEl.contains(e.target)) {
            resultsEl.classList.remove('active');
        }
    });
}

// Setup buyer autocomplete
setupAutocomplete(
    document.getElementById('buyerSearch'),
    document.getElementById('buyerHidden'),
    document.getElementById('buyerResults')
);

function toggleType() {
    currentType = document.getElementById('contractType').value;
    document.getElementById('achatSelect').style.display = currentType === 'ACHAT' ? 'block' : 'none';
    document.getElementById('locationSelect').style.display = currentType === 'LOCATION' ? 'block' : 'none';
    document.getElementById('partiesSection').style.display = currentType ? 'block' : 'none';
    document.getElementById('sellerLabel').textContent = currentType === 'LOCATION' ? 'Proprietaire' : 'Vendeur';
    document.getElementById('buyerLabel').textContent = currentType === 'LOCATION' ? 'Locataire *' : 'Acheteur *';
    updateOwner();
}

function updateOwner() {
    var type = document.getElementById('contractType').value;
    var select = type === 'ACHAT' ? document.getElementById('achatId') : document.getElementById('locationId');
    var option = select.options[select.selectedIndex];
    var bienId = option ? option.getAttribute('data-bien-id') : null;
    var display = document.getElementById('ownerDisplay');

    currentOwnerId = null;

    if (bienId && bienOwners[bienId]) {
        var owner = bienOwners[bienId];
        display.value = owner.prenom + ' ' + owner.nom;
        currentOwnerId = owner.personneId;
    } else if (bienId) {
        display.value = 'Aucun proprietaire defini';
    } else {
        display.value = '';
    }
}

// Auto-select listing from query params
(function() {
    var preAchatId = '{{ preselectedAchatId ?? '' }}';
    var preLocationId = '{{ preselectedLocationId ?? '' }}';
    if (preAchatId) {
        document.getElementById('contractType').value = 'ACHAT';
        toggleType();
        document.getElementById('achatId').value = preAchatId;
        updateOwner();
    } else if (preLocationId) {
        document.getElementById('contractType').value = 'LOCATION';
        toggleType();
        document.getElementById('locationId').value = preLocationId;
        updateOwner();
    }
})();

// Validate signers before submit
document.querySelector('form').addEventListener('submit', function(e) {
    var buyerHidden = document.getElementById('buyerHidden');
    if (!buyerHidden.value) {
        e.preventDefault();
        alert('Veuillez selectionner un signataire valide depuis la liste.');
    }
});
</script>
{% endblock %}
