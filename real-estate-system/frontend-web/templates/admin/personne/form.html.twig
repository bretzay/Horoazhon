{% extends 'base.html.twig' %}

{% block title %}Admin - {{ personne ? 'Modifier' : 'Nouvelle' }} Personne{% endblock %}

{% block stylesheets %}
{% if personne %}
<style>
    .person-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
    .person-panels .card { margin-bottom: 0; }
    .scroll-list { max-height: 50vh; overflow-y: auto; }
    .scroll-list table { margin: 0; }
    @media (max-width: 768px) { .person-panels { grid-template-columns: 1fr; } }
</style>
{% endif %}
{% endblock %}

{% block body %}
<div class="page-header">
    <h1>{{ personne ? 'Modifier Personne #' ~ personne.id : 'Nouvelle Personne' }}</h1>
    <a href="{{ path('admin_personnes') }}" class="btn btn-secondary">Retour</a>
</div>

<div class="card">
    <form method="POST">
        <div class="form-row">
            <div class="form-group"><label>Nom *</label><input type="text" name="nom" value="{{ personne ? personne.nom : '' }}" required></div>
            <div class="form-group"><label>Prenom *</label><input type="text" name="prenom" value="{{ personne ? personne.prenom : '' }}" required></div>
            <div class="form-group"><label>Date de naissance *</label><input type="date" name="dateNais" value="{{ personne ? personne.dateNais : '' }}" required></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Rue</label><input type="text" name="rue" value="{{ personne ? personne.rue : '' }}"></div>
            <div class="form-group"><label>Ville</label><input type="text" name="ville" value="{{ personne ? personne.ville : '' }}"></div>
            <div class="form-group"><label>Code Postal</label><input type="text" name="codePostal" value="{{ personne ? personne.codePostal : '' }}"></div>
        </div>
        <div class="form-group"><label>RIB (IBAN)</label><input type="text" name="rib" value="{{ personne ? personne.rib : '' }}" maxlength="34"></div>
        <button type="submit" class="btn btn-primary">{{ personne ? 'Enregistrer' : 'Creer' }}</button>
    </form>
</div>

{% if personne %}
<div class="card">
    <h3>Compte client</h3>
    {% if accountStatus is defined and accountStatus and accountStatus.hasAccount %}
        {% if accountStatus.status == 'ACTIVE' %}
            <span class="badge badge-signe">Compte actif</span>
            <span style="color: #64748b; margin-left: 0.5rem;">{{ accountStatus.email }}</span>
        {% elseif accountStatus.status == 'PENDING' %}
            <span class="badge badge-en_cours">En attente d'activation</span>
            <span style="color: #64748b; margin-left: 0.5rem;">{{ accountStatus.email }}</span>
        {% elseif accountStatus.status == 'EXPIRED' %}
            <span class="badge badge-annule">Lien expire</span>
            <span style="color: #64748b; margin-left: 0.5rem;">{{ accountStatus.email }}</span>
            <form method="POST" action="{{ path('admin_personnes_invite', {id: personne.id}) }}" style="display: inline; margin-left: 1rem;">
                <input type="hidden" name="invite_email" value="{{ accountStatus.email }}">
                <button type="submit" class="btn btn-primary btn-sm">Renvoyer l'invitation</button>
            </form>
        {% endif %}
    {% else %}
        <p style="color: #64748b; margin-bottom: 0.75rem;">Cette personne n'a pas encore de compte sur le site.</p>
        <form method="POST" action="{{ path('admin_personnes_invite', {id: personne.id}) }}" class="form-inline">
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="invite_email" placeholder="email@example.com" required>
            </div>
            <button type="submit" class="btn btn-success">Envoyer l'invitation</button>
        </form>
    {% endif %}
</div>

<div class="person-panels">
    <div class="card">
        <h3>Biens possedes ({{ biens|length }})</h3>
        <div class="scroll-list">
            {% if biens|length > 0 %}
            <table>
                <thead>
                    <tr><th>Type</th><th>Adresse</th><th>Statut</th><th></th></tr>
                </thead>
                <tbody>
                    {% for b in biens %}
                    <tr>
                        <td>{{ b.type ?? '-' }}</td>
                        <td>{{ b.rue }}, {{ b.ville }}</td>
                        <td>
                            {% if b.availableForSale %}<span class="badge badge-sale">Vente</span>{% endif %}
                            {% if b.availableForRent %}<span class="badge badge-rent">Location</span>{% endif %}
                            {% if not b.availableForSale and not b.availableForRent %}<span class="badge" style="background:#f1f5f9;color:#94a3b8;">-</span>{% endif %}
                        </td>
                        <td><a href="{{ path('admin_biens_edit', {id: b.id}) }}" class="btn btn-primary btn-sm">Voir</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: #94a3b8;">Aucun bien.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <h3>Contrats ({{ contrats|length }})</h3>
        <div class="scroll-list">
            {% if contrats|length > 0 %}
            <table>
                <thead>
                    <tr><th>ID</th><th>Type</th><th>Bien</th><th>Statut</th><th></th></tr>
                </thead>
                <tbody>
                    {% for c in contrats %}
                    <tr>
                        <td>#{{ c.id }}</td>
                        <td>{{ c.type == 'LOCATION' ? 'Location' : 'Achat' }}</td>
                        <td>{% if c.bien %}{{ c.bien.type ?? '' }} - {{ c.bien.rue ?? '' }}, {{ c.bien.ville ?? '' }}{% else %}-{% endif %}</td>
                        <td>
                            {% if c.statut == 'EN_COURS' %}<span class="badge" style="background:#fef3c7;color:#92400e;">En cours</span>
                            {% elseif c.statut == 'SIGNE' %}<span class="badge" style="background:#d1fae5;color:#065f46;">Signe</span>
                            {% elseif c.statut == 'ANNULE' %}<span class="badge" style="background:#fee2e2;color:#991b1b;">Annule</span>
                            {% else %}<span class="badge" style="background:#f1f5f9;color:#94a3b8;">{{ c.statut }}</span>{% endif %}
                        </td>
                        <td><a href="{{ path('admin_contrats_detail', {id: c.id}) }}" class="btn btn-primary btn-sm">Voir</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: #94a3b8;">Aucun contrat.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
